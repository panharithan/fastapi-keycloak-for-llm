version: "3.9"

services:
  app:
    build: .
    container_name: fastapi-keycloak-app
    expose:
      - "8000"  # FastAPI internal
      - "7860"  # Gradio internal
    env_file: .env
    environment:
      # üîë Keycloak Configuration
      KEYCLOAK_URL: http://keycloak:${KEYCLOAK_PORT}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM}
      CLIENT_ID: ${CLIENT_ID}
      CLIENT_SECRET: ${CLIENT_SECRET}
      KEYCLOAK_TOKEN_URL: http://keycloak:${KEYCLOAK_PORT}/realms/${KEYCLOAK_REALM}/protocol/openid-connect/token
      VERIFY_URL: ${VERIFY_URL:-http://keycloak:${KEYCLOAK_PORT}/verify}

      # üìß Email Configuration
      EMAIL_HOST_USER: ${EMAIL_HOST_USER}
      EMAIL_HOST_PASSWORD: ${EMAIL_HOST_PASSWORD}
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}

      # üçÉ External MongoDB Configuration
      MONGO_USER: ${MONGO_USER}
      MONGO_PASS: ${MONGO_PASS}
      MONGO_HOST: ${MONGO_HOST}
      MONGO_DB_PORT: ${MONGO_DB_PORT}
      MONGO_DB: ${MONGO_DB}

      # ü§ñ LLM API
      OLLAMA_API_URL: http://host.docker.internal:11434/api/generate
      MODEL: llama3.2

    networks:
      - llm-net
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # üåê Nginx Reverse Proxy
  nginx:
    image: nginx:latest
    container_name: nginx-proxy
    restart: always
    depends_on:
      - app
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro  # optional for SSL
    networks:
      - llm-net

networks:
  llm-net:
    external: true
